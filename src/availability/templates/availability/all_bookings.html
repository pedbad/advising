{% extends "core/base.html" %}

{% block title %}All Bookings - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="mb-6 flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
    <div>
      <h1 class="text-3xl font-bold mb-2">All Bookings</h1>
      <p class="text-muted-foreground">
        {% if show_past %}
          Review historic meetings between students and advisors.
        {% else %}
          Review every upcoming meeting across students and advisors.
        {% endif %}
      </p>
    </div>
    <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
      <a
        href="{% if show_past %}{% url 'availability:all_bookings' %}{% else %}{% url 'availability:all_bookings' %}?show=past{% endif %}"
        class="inline-flex items-center justify-center gap-2 h-9 px-4 py-2 rounded-md border border-input bg-background shadow-xs hover:bg-accent hover:text-accent-foreground transition-colors text-sm font-medium"
      >
        {% if show_past %}
          View upcoming bookings
        {% else %}
          See past bookings
        {% endif %}
      </a>
      <a
        href="{% url 'users:admin_home' %}"
        class="inline-flex items-center justify-center gap-2 h-9 px-4 py-2 rounded-md border border-input bg-background shadow-xs hover:bg-accent hover:text-accent-foreground transition-colors text-sm font-medium"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
        Back to Dashboard
      </a>
    </div>
  </div>

  {% if has_bookings %}
  <div
    x-data="{
      groupBy: 'date',
      filter: 'all',
      selectedDate: '',
      allSlots: [
        {% for slot in all_slots %}
          { date: '{{ slot.date }}', type: '{{ slot.meeting_type }}' }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      get hasVisibleSlots() {
        return this.allSlots.some(slot => {
          const matchesDate = !this.selectedDate || this.selectedDate === slot.date;
          const matchesType = this.filter === 'all' || this.filter === slot.type;
          return matchesDate && matchesType;
        });
      },
      init() {
        this.$watch('selectedDate', value => {
          if (value) {
            this.groupBy = 'teacher';
          }
        });
      },
      clearDate() {
        this.selectedDate = '';
        this.groupBy = 'date';
      },
      clearAllFilters() {
        this.selectedDate = '';
        this.filter = 'all';
        this.groupBy = 'date';
      }
    }"
  >
    <c-card class="mb-6 p-6">
      <div class="flex flex-col gap-6 md:flex-row md:items-start md:justify-between">
        <div class="flex-1 space-y-4">
          <div x-show="!selectedDate">
            <label class="text-sm font-medium mb-2 block">View:</label>
            <div class="flex gap-2">
              <button
                @click="groupBy = 'date'"
                :class="groupBy === 'date' ? 'bg-primary text-primary-foreground' : 'bg-background border border-input hover:bg-accent'"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
              >
                Sort by Date
              </button>
              <button
                @click="groupBy = 'teacher'"
                :class="groupBy === 'teacher' ? 'bg-primary text-primary-foreground' : 'bg-background border border-input hover:bg-accent'"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
              >
                Group by Advisor
              </button>
            </div>
          </div>

          <div>
            <label class="text-sm font-medium mb-2 block">Filter by meeting type:</label>
            <div class="flex flex-wrap gap-2">
              <button
                @click="filter = 'all'"
                :class="filter === 'all' ? 'bg-primary text-primary-foreground' : 'bg-background border border-input hover:bg-accent'"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
              >
                All
              </button>
              <button
                @click="filter = 'online'"
                :class="filter === 'online' ? 'bg-blue-500 text-white border-blue-500' : 'bg-blue-50 text-blue-700 border-blue-300 hover:bg-blue-100'"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors border-2"
              >
                Online
              </button>
              <button
                @click="filter = 'in_person'"
                :class="filter === 'in_person' ? 'bg-green-500 text-white border-green-500' : 'bg-green-50 text-green-700 border-green-300 hover:bg-green-100'"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors border-2"
              >
                In-person
              </button>
              <button
                @click="filter = 'both'"
                :class="filter === 'both' ? 'bg-purple-500 text-white border-purple-500' : 'bg-purple-50 text-purple-700 border-purple-300 hover:bg-purple-100'"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors border-2"
              >
                Both
              </button>
            </div>
          </div>
        </div>

        <div class="flex-shrink-0 w-full md:w-72">
          <label class="text-sm font-medium mb-2 block">Jump to date:</label>
          <div class="space-y-2">
            <input
              type="date"
              x-model="selectedDate"
              {% if show_past %}
              max="{{ today|date:'Y-m-d' }}"
              {% else %}
              min="{{ today|date:'Y-m-d' }}"
              {% endif %}
              class="w-full px-3 py-2 rounded-md border border-input bg-card text-sm focus:outline-none focus:ring-2 focus:ring-ring [color-scheme:light] dark:[color-scheme:dark]"
            >
            <button
              x-show="selectedDate"
              @click="clearDate()"
              class="w-full px-4 py-2 rounded-md text-sm font-medium bg-background border border-input hover:bg-accent hover:text-accent-foreground transition-colors"
            >
              Clear Date
            </button>
          </div>
        </div>
      </div>
    </c-card>

    <div x-show="groupBy === 'date'" x-transition x-ref="dateView">
      {% for booking_date, items in bookings_by_date.items %}
      <c-card
        class="mb-4"
        data-date-card="{{ booking_date|date:'Y-m-d' }}"
        x-show="!selectedDate || selectedDate === '{{ booking_date|date:'Y-m-d' }}'"
      >
        <div class="border-b bg-muted/30 px-6 py-4">
          <h2 class="text-xl font-semibold">
            {% if booking_date == today %}
              Today
            {% elif booking_date == tomorrow %}
              Tomorrow
            {% else %}
              {{ booking_date|date:"l, F j, Y" }}
            {% endif %}
          </h2>
        </div>
        <div class="p-6 space-y-3">
          {% for booking in items %}
          <div
            class="rounded-lg border p-4 hover:bg-accent/50 transition-colors"
            data-meeting-type="{{ booking.availability.meeting_type }}"
            x-show="filter === 'all' || filter === '{{ booking.availability.meeting_type }}'"
          >
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
              <div>
                <p class="text-sm uppercase text-muted-foreground">Student</p>
                <p class="font-medium">{{ booking.student.get_full_name|default:booking.student.email }}</p>
                <p class="text-xs text-muted-foreground">{{ booking.student.email }}</p>
              </div>
              <div>
                <p class="text-sm uppercase text-muted-foreground">Advisor</p>
                <p class="font-medium">{{ booking.availability.teacher.get_full_name|default:booking.availability.teacher.email }}</p>
                <p class="text-xs text-muted-foreground">{{ booking.availability.teacher.email }}</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium">{{ booking.availability.start_time|time:"g:i A" }} – {{ booking.availability.end_time|time:"g:i A" }}</span>
                {% if booking.availability.meeting_type == 'online' %}
                  <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                    <span class="h-2 w-2 rounded-full bg-blue-500"></span>
                    Online
                  </span>
                {% elif booking.availability.meeting_type == 'in_person' %}
                  <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                    <span class="h-2 w-2 rounded-full bg-green-500"></span>
                    In-person
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                    <span class="h-2 w-2 rounded-full bg-purple-500"></span>
                    Both
                  </span>
                {% endif %}
              </div>
            </div>

            {% if booking.availability.message %}
            <div class="mt-3 w-full px-3 py-2 text-sm rounded-md border border-slate-200 bg-slate-50 dark:bg-slate-900/40 dark:border-slate-700">
              <span class="font-semibold">Advisor note:</span>
              {{ booking.availability.message }}
            </div>
            {% endif %}

            {% if booking.message %}
            <div class="mt-3 flex items-start gap-2 text-sm text-sky-900/90 dark:text-sky-100">
              {% include "core/icons/chat.html" with class="h-4 w-4 text-sky-500 dark:text-sky-300 mt-0.5" %}
              <span>
                <span class="font-semibold">Student note:</span>
                {{ booking.message }}
              </span>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </c-card>
      {% endfor %}
    </div>

    <div x-show="groupBy === 'teacher'" x-transition style="display:none;" x-ref="teacherView">
      {% for block in bookings_by_teacher %}
      <c-card
        class="mb-4"
        data-teacher-card="true"
        data-teacher-dates="{% for booking in block.bookings %}{{ booking.availability.date|date:'Y-m-d' }}{% if not forloop.last %},{% endif %}{% endfor %}"
        data-teacher-types="{% for booking in block.bookings %}{{ booking.availability.meeting_type }}{% if not forloop.last %},{% endif %}{% endfor %}"
        x-show="(() => {
          const dates = $el.dataset.teacherDates.split(',');
          const types = $el.dataset.teacherTypes.split(',');
          for (let i = 0; i < dates.length; i++) {
            const matchesDate = !selectedDate || selectedDate === dates[i];
            const matchesType = filter === 'all' || filter === types[i];
            if (matchesDate && matchesType) return true;
          }
          return false;
        })()"
      >
        <div class="border-b bg-muted/30 px-6 py-4">
          <h2 class="text-xl font-semibold">{{ block.teacher.get_full_name|default:block.teacher.email }}</h2>
          <p class="text-sm text-muted-foreground">{{ block.teacher.email }}</p>
        </div>
        <div class="p-6 space-y-3">
          {% for booking in block.bookings %}
          <div
            class="rounded-lg border p-4 hover:bg-accent/50 transition-colors"
            data-meeting-type="{{ booking.availability.meeting_type }}"
            data-slot-date="{{ booking.availability.date|date:'Y-m-d' }}"
            x-show="(filter === 'all' || filter === '{{ booking.availability.meeting_type }}') && (!selectedDate || selectedDate === '{{ booking.availability.date|date:'Y-m-d' }}')"
          >
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
              <div>
                <p class="text-sm uppercase text-muted-foreground">Student</p>
                <p class="font-medium">{{ booking.student.get_full_name|default:booking.student.email }}</p>
                <p class="text-xs text-muted-foreground">{{ booking.student.email }}</p>
              </div>
              <div>
                <p class="text-sm uppercase text-muted-foreground">Date</p>
                <p class="font-medium">{{ booking.availability.date|date:"l, F j, Y" }}</p>
                <p class="text-xs text-muted-foreground">{{ booking.availability.start_time|time:"g:i A" }} – {{ booking.availability.end_time|time:"g:i A" }}</p>
              </div>
              <div class="flex items-center gap-2">
                {% if booking.availability.meeting_type == 'online' %}
                  <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                    <span class="h-2 w-2 rounded-full bg-blue-500"></span>
                    Online
                  </span>
                {% elif booking.availability.meeting_type == 'in_person' %}
                  <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                    <span class="h-2 w-2 rounded-full bg-green-500"></span>
                    In-person
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                    <span class="h-2 w-2 rounded-full bg-purple-500"></span>
                    Both
                  </span>
                {% endif %}
              </div>
            </div>

            {% if booking.availability.message %}
            <div class="mt-3 w-full px-3 py-2 text-sm rounded-md border border-slate-200 bg-slate-50 dark:bg-slate-900/40 dark:border-slate-700">
              <span class="font-semibold">Advisor note:</span>
              {{ booking.availability.message }}
            </div>
            {% endif %}

            {% if booking.message %}
            <div class="mt-3 flex items-start gap-2 text-sm text-sky-900/90 dark:text-sky-100">
              {% include "core/icons/chat.html" with class="h-4 w-4 text-sky-500 dark:text-sky-300 mt-0.5" %}
              <span>
                <span class="font-semibold">Student note:</span>
                {{ booking.message }}
              </span>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </c-card>
      {% endfor %}
    </div>

    <div x-show="!hasVisibleSlots" x-transition>
      <c-card class="p-12">
        <div class="text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-xl font-semibold mb-2">No bookings match the current filters</h3>
          <p class="text-muted-foreground mb-6">
            Adjust meeting type or pick another date to continue exploring bookings.
          </p>
          <button
            @click="clearAllFilters()"
            class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-md text-sm font-medium bg-primary text-primary-foreground hover:opacity-90 transition-opacity"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            Clear All Filters
          </button>
        </div>
      </c-card>
    </div>
  </div>
  {% else %}
    <c-card class="p-12">
      <div class="text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <h3 class="text-xl font-semibold mb-2">No bookings yet</h3>
        <p class="text-muted-foreground">Bookings will appear here as soon as students reserve slots.</p>
      </div>
    </c-card>
  {% endif %}
</div>
{% endblock %}
