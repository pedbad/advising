{% extends "core/base.html" %}

{% block title %}Upcoming Availability - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  {# Header #}
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold mb-2">Upcoming Availability</h1>
      <p class="text-muted-foreground">View all upcoming availability slots from all teachers</p>
    </div>
    <a
      href="{% url 'users:admin_home' %}"
      class="inline-flex items-center justify-center gap-2 h-9 px-4 py-2 rounded-md border border-input bg-background shadow-xs hover:bg-accent hover:text-accent-foreground transition-colors text-sm font-medium"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
      </svg>
      Back to Dashboard
    </a>
  </div>

  {% if has_slots %}
    <div x-data="{
      groupBy: 'date',
      filter: 'all',
      selectedDate: '',
      allSlots: [
        {% for date, slots in availabilities_by_date.items %}
          {% for slot in slots %}
            {
              date: '{{ slot.date|date:"Y-m-d" }}',
              type: '{{ slot.meeting_type }}'
            }{% if not forloop.last or not forloop.parentloop.last %},{% endif %}
          {% endfor %}
        {% endfor %}
      ],
      get hasVisibleSlots() {
        return this.allSlots.some(slot => {
          const matchesDate = !this.selectedDate || this.selectedDate === slot.date;
          const matchesType = this.filter === 'all' || this.filter === slot.type;
          return matchesDate && matchesType;
        });
      },
      init() {
        this.$watch('selectedDate', value => {
          if (value) {
            this.groupBy = 'teacher';
          }
        });
      },
      clearDate() {
        this.selectedDate = '';
        this.groupBy = 'date';
      },
      clearAllFilters() {
        this.selectedDate = '';
        this.filter = 'all';
        this.groupBy = 'date';
      }
    }">
      {# Controls: Filters on left, Date Picker on right #}
      <c-card class="mb-6 p-6">
        <div class="flex gap-6 items-start justify-between">
          {# Left Side - View Toggle and Filters #}
          <div class="flex-1 space-y-4">
            {# Group By Toggle #}
            <div x-show="!selectedDate">
              <label class="text-sm font-medium mb-2 block">View:</label>
              <div class="flex gap-2">
                <button
                  @click="groupBy = 'date'"
                  :class="groupBy === 'date' ? 'bg-primary text-primary-foreground' : 'bg-background border border-input hover:bg-accent'"
                  class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
                >
                  Sort by Date/Time
                </button>
                <button
                  @click="groupBy = 'teacher'"
                  :class="groupBy === 'teacher' ? 'bg-primary text-primary-foreground' : 'bg-background border border-input hover:bg-accent'"
                  class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
                >
                  Group by Teacher
                </button>
              </div>
            </div>

            {# Meeting Type Filters #}
            <div>
              <label class="text-sm font-medium mb-2 block">Filter by meeting type:</label>
              <div class="flex flex-wrap gap-2">
                <button
                  @click="filter = 'all'"
                  :class="filter === 'all' ? 'bg-primary text-primary-foreground' : 'bg-background border border-input hover:bg-accent'"
                  class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
                >
                  All
                </button>
                <button
                  @click="filter = 'online'"
                  :class="filter === 'online' ? 'bg-blue-500 text-white border-blue-500' : 'bg-blue-50 text-blue-700 border-blue-300 hover:bg-blue-100'"
                  class="px-4 py-2 rounded-md text-sm font-medium transition-colors border-2"
                >
                  Online
                </button>
                <button
                  @click="filter = 'in_person'"
                  :class="filter === 'in_person' ? 'bg-green-500 text-white border-green-500' : 'bg-green-50 text-green-700 border-green-300 hover:bg-green-100'"
                  class="px-4 py-2 rounded-md text-sm font-medium transition-colors border-2"
                >
                  In-Person
                </button>
                <button
                  @click="filter = 'both'"
                  :class="filter === 'both' ? 'bg-purple-500 text-white border-purple-500' : 'bg-purple-50 text-purple-700 border-purple-300 hover:bg-purple-100'"
                  class="px-4 py-2 rounded-md text-sm font-medium transition-colors border-2"
                >
                  Both
                </button>
              </div>
            </div>
          </div>

          {# Right Side - Date Picker #}
          <div class="flex-shrink-0 w-72">
            <label class="text-sm font-medium mb-2 block">Select a specific date:</label>
            <div class="space-y-2">
              <input
                type="date"
                x-model="selectedDate"
                min="{{ today|date:'Y-m-d' }}"
                class="w-full px-3 py-2 rounded-md border border-input bg-card text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring [color-scheme:light] dark:[color-scheme:dark]"
              >
              <button
                x-show="selectedDate"
                @click="clearDate()"
                class="w-full px-4 py-2 rounded-md text-sm font-medium bg-background border border-input hover:bg-accent hover:text-accent-foreground transition-colors"
              >
                Clear Date
              </button>
            </div>
          </div>
        </div>
      </c-card>

      {# Sorted by Date View #}
      <div x-show="groupBy === 'date'" x-transition x-ref="dateViewContainer">
        {% for date, slots in availabilities_by_date.items %}
          <c-card
            class="mb-4"
            data-date-card="{{ date|date:'Y-m-d' }}"
            x-show="!selectedDate || selectedDate === '{{ date|date:"Y-m-d" }}'"
          >
            <div class="border-b bg-muted/30 px-6 py-4">
              <h2 class="text-xl font-semibold">
                {% if date == today %}
                  Today
                {% elif date == tomorrow %}
                  Tomorrow
                {% else %}
                  {{ date|date:"l, F j, Y" }}
                {% endif %}
              </h2>
            </div>
            <div class="p-6">
              <div class="space-y-3">
                {% for slot in slots %}
                  <div
                    class="p-4 rounded-lg border hover:bg-accent/50 transition-colors {% if slot.booking %}border-sky-200 bg-sky-50 ring-1 ring-sky-100{% endif %}"
                    data-meeting-type="{{ slot.meeting_type }}"
                    x-show="filter === 'all' || filter === '{{ slot.meeting_type }}'"
                  >
                    <div class="flex items-center gap-4">
                      {# Time #}
                      <div class="flex-shrink-0 w-40">
                        <div class="font-medium">{{ slot.start_time|time:"g:i A" }} - {{ slot.end_time|time:"g:i A" }}</div>
                        {% if slot.booking %}
                          <div class="mt-1 inline-flex items-center gap-1 text-xs font-semibold text-sky-800 dark:text-sky-200">
                            <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-amber-900 dark:bg-amber-300/20 dark:text-amber-100">
                              Booked
                              {% if slot.booking.student %}
                                by {{ slot.booking.student.get_full_name|default:slot.booking.student.email }}
                              {% endif %}
                            </span>
                          </div>
                        {% endif %}
                      </div>

                      {# Teacher Info #}
                      <div class="flex-1">
                        <div class="font-medium">{{ slot.teacher.get_full_name|default:slot.teacher.email }}</div>
                        <div class="text-sm text-muted-foreground">{{ slot.teacher.email }}</div>
                      </div>

                      {# Meeting Type Badge #}
                      <div class="flex-shrink-0">
                        {% if slot.meeting_type == 'online' %}
                          <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                            <div class="h-2 w-2 rounded-full bg-blue-500"></div>
                            Online
                          </span>
                        {% elif slot.meeting_type == 'in_person' %}
                          <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                            <div class="h-2 w-2 rounded-full bg-green-500"></div>
                            In-Person
                          </span>
                        {% elif slot.meeting_type == 'both' %}
                          <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                            <div class="h-2 w-2 rounded-full bg-purple-500"></div>
                            Both
                          </span>
                        {% endif %}
                      </div>

                      {# Message (if present) #}
                      {% if slot.message %}
                        <div class="flex-shrink-0">
                          <div class="px-3 py-1.5 text-xs rounded-md bg-amber-50 border border-amber-200 text-amber-900 max-w-xs">
                            <span class="font-medium">Note:</span> {{ slot.message }}
                          </div>
                        </div>
                      {% endif %}
                    </div>

                    {% if slot.booking and slot.booking.message %}
                    <div class="w-full mt-3 flex items-start gap-1.5 text-sm text-sky-900/90 dark:text-sky-100">
                      <span class="mt-0.5 text-sky-500 dark:text-sky-300">
                        {% include "core/icons/chat.html" with class="h-4 w-4" %}
                      </span>
                      <span class="leading-snug">
                        <span class="font-semibold text-sky-900 dark:text-sky-100">Student note:</span>
                        {{ slot.booking.message }}
                      </span>
                    </div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          </c-card>
        {% endfor %}
      </div>

      {# Grouped by Teacher View #}
      <div x-show="groupBy === 'teacher'" x-transition style="display: none;" x-ref="teacherViewContainer">
        {% for teacher_data in availabilities_by_teacher %}
          <c-card
            class="mb-4"
            data-teacher-card="true"
            data-teacher-dates="{% for slot in teacher_data.slots %}{{ slot.date|date:'Y-m-d' }}{% if not forloop.last %},{% endif %}{% endfor %}"
            data-teacher-types="{% for slot in teacher_data.slots %}{{ slot.meeting_type }}{% if not forloop.last %},{% endif %}{% endfor %}"
            x-show="(() => {
              const dates = $el.dataset.teacherDates.split(',');
              const types = $el.dataset.teacherTypes.split(',');

              for (let i = 0; i < dates.length; i++) {
                const matchesDate = !selectedDate || selectedDate === dates[i];
                const matchesType = filter === 'all' || filter === types[i];
                if (matchesDate && matchesType) return true;
              }
              return false;
            })()"
          >
            <div class="border-b bg-muted/30 px-6 py-4">
              <h2 class="text-xl font-semibold">{{ teacher_data.teacher.get_full_name|default:teacher_data.teacher.email }}</h2>
              <p class="text-sm text-muted-foreground">{{ teacher_data.teacher.email }}</p>
            </div>
            <div class="p-6">
              <div class="space-y-3">
                {% for slot in teacher_data.slots %}
                  <div
                    class="p-4 rounded-lg border hover:bg-accent/50 transition-colors {% if slot.booking %}border-sky-200 bg-sky-50 ring-1 ring-sky-100{% endif %}"
                    data-meeting-type="{{ slot.meeting_type }}"
                    data-slot-date="{{ slot.date|date:'Y-m-d' }}"
                    x-show="(filter === 'all' || filter === '{{ slot.meeting_type }}') && (!selectedDate || selectedDate === '{{ slot.date|date:"Y-m-d" }}')"
                  >
                    <div class="flex items-center gap-4">
                      {# Date #}
                      <div class="flex-shrink-0 w-48">
                        <div class="font-medium">{{ slot.date|date:"l, M j, Y" }}</div>
                      </div>

                      {# Time #}
                      <div class="flex-shrink-0 w-40">
                        <div class="font-medium">{{ slot.start_time|time:"g:i A" }} - {{ slot.end_time|time:"g:i A" }}</div>
                        {% if slot.booking %}
                          <div class="mt-1 inline-flex items-center gap-1 text-xs font-semibold text-sky-800 dark:text-sky-200">
                            <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-amber-900 dark:bg-amber-300/20 dark:text-amber-100">
                              Booked
                              {% if slot.booking.student %}
                                by {{ slot.booking.student.get_full_name|default:slot.booking.student.email }}
                              {% endif %}
                            </span>
                          </div>
                        {% endif %}
                      </div>

                      {# Meeting Type Badge #}
                      <div class="flex-shrink-0">
                        {% if slot.meeting_type == 'online' %}
                          <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                            <div class="h-2 w-2 rounded-full bg-blue-500"></div>
                            Online
                          </span>
                        {% elif slot.meeting_type == 'in_person' %}
                          <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                            <div class="h-2 w-2 rounded-full bg-green-500"></div>
                            In-Person
                          </span>
                        {% elif slot.meeting_type == 'both' %}
                          <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                            <div class="h-2 w-2 rounded-full bg-purple-500"></div>
                            Both
                          </span>
                        {% endif %}
                      </div>

                      {# Message (if present) #}
                      {% if slot.message %}
                        <div class="flex-1">
                          <div class="px-3 py-1.5 text-xs rounded-md bg-amber-50 border border-amber-200 text-amber-900">
                            <span class="font-medium">Note:</span> {{ slot.message }}
                          </div>
                        </div>
                      {% endif %}
                    </div>

                    {% if slot.booking and slot.booking.message %}
                    <div class="w-full mt-3 flex items-start gap-1.5 text-sm text-sky-900/90 dark:text-sky-100">
                      <span class="mt-0.5 text-sky-500 dark:text-sky-300">
                        {% include "core/icons/chat.html" with class="h-4 w-4" %}
                      </span>
                      <span class="leading-snug">
                        <span class="font-semibold text-sky-900 dark:text-sky-100">Student note:</span>
                        {{ slot.booking.message }}
                      </span>
                    </div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          </c-card>
        {% endfor %}
      </div>

      {# No Results Empty State #}
      <div
        x-show="!hasVisibleSlots"
        x-transition
      >
        <c-card class="p-12">
          <div class="text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="text-xl font-semibold mb-2">No Results Found</h3>
            <p class="text-muted-foreground mb-6">
              No availability slots match your current filters.
              <span x-show="selectedDate">
                Try selecting a different date or clearing your filters.
              </span>
            </p>
            <button
              @click="clearAllFilters()"
              class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-md text-sm font-medium bg-primary text-primary-foreground hover:opacity-90 transition-opacity"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
              </svg>
              Clear All Filters
            </button>
          </div>
        </c-card>
      </div>
    </div>
  {% else %}
    {# Empty State #}
    <c-card class="p-12">
      <div class="text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <h3 class="text-xl font-semibold mb-2">No Upcoming Availability</h3>
        <p class="text-muted-foreground">There are no availability slots set by teachers yet.</p>
      </div>
    </c-card>
  {% endif %}
</div>
{% endblock %}
