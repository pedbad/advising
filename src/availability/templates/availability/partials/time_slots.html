{# Time Slots List - Partial for HTMX updates #}
<div class="space-y-2 max-h-[600px] overflow-y-auto" id="time-slots-container">
  {% for slot in time_slots %}
  <div
    x-data="{
      slotTime: '{{ slot.start_time|time:"H:i:s" }}',
      selectedType: {% if slot.is_available %}'{{ slot.meeting_type }}'{% else %}null{% endif %},
      message: '{{ slot.message|escapejs }}',
      isBlocked: {{ slot.is_blocked|yesno:'true,false' }},
      blockingType: {% if slot.blocking_meeting_type %}'{{ slot.blocking_meeting_type }}'{% else %}null{% endif %},
      isBooked: {{ slot.is_booked|yesno:'true,false' }},
      saving: false,
      showNoteModal: false,
      pendingType: null,
      pendingAction: null,
      tempMessage: '',

      isActive(type) {
        return this.selectedType === type;
      },

      startSetType(type) {
        if (this.saving) return;
        if (this.selectedType === type) {
          this.selectType(type, 'delete');
          return;
        }
        this.pendingType = type;
        this.pendingAction = 'set';
        this.tempMessage = this.message || '';
        this.showNoteModal = true;
      },

      editMessage() {
        if (!this.selectedType || this.saving) return;
        this.pendingType = this.selectedType;
        this.pendingAction = 'set';
        this.tempMessage = this.message || '';
        this.showNoteModal = true;
      },

      cancelModal() {
        this.showNoteModal = false;
        this.pendingType = null;
        this.pendingAction = null;
        this.tempMessage = '';
      },

      async confirmModal() {
        const note = (this.tempMessage || '').trim();
        await this.selectType(this.pendingType, this.pendingAction, note);
        this.cancelModal();
      },

      async selectType(type, forcedAction = null, overrideMessage = null) {
        if (this.saving || !type) return;
        this.saving = true;
        const action = forcedAction ?? (this.selectedType === type ? 'delete' : 'set');
        const messageValue = action === 'delete' ? '' : (overrideMessage ?? this.message ?? '');

        const formData = new FormData();
        formData.append('date', '{{ selected_date|date:"Y-m-d" }}');
        formData.append('start_time', this.slotTime);
        formData.append('meeting_type', type);
        formData.append('message', messageValue);
        formData.append('action', action);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        {% if is_admin_view and viewing_teacher %}
        formData.append('teacher_id', '{{ viewing_teacher.id }}');
        {% endif %}

        try {
          const response = await fetch('{% url 'availability:save_availability' %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            this.message = messageValue;
            if (action === 'delete') {
              this.selectedType = null;
            } else {
              this.selectedType = type;
            }

            const container = document.getElementById('time-slots-container');
            const scrollTop = container ? container.scrollTop : 0;

            htmx.ajax('GET', window.location.pathname + window.location.search, {
              target: '#time-slots-wrapper',
              swap: 'innerHTML show:none'
            }).then(() => {
              const newContainer = document.getElementById('time-slots-container');
              if (newContainer) {
                newContainer.scrollTop = scrollTop;
              }
            });
          } else {
            alert('Error: ' + (data.error || 'Failed to save availability'));
          }
        } catch (error) {
          console.error('Fetch error:', error);
          alert('Error: ' + error.message);
        } finally {
          this.saving = false;
        }
      }
    }"
    :class="{
      'bg-sky-50 dark:bg-sky-900/30 border-sky-200 dark:border-sky-700 ring-1 ring-sky-100 dark:ring-sky-800': isBooked,
      'opacity-60 bg-muted dark:bg-muted/30': isBlocked && !isBooked,
      'bg-card hover:bg-accent/50 dark:bg-muted/20 dark:hover:bg-muted/40': !isBlocked && !isBooked
    }"
    class="flex items-center gap-3 p-3 rounded-lg border transition-colors text-slate-900 dark:text-slate-100"
  >
    {# Time Display #}
    <div class="min-w-[180px]">
      <span class="text-sm font-medium">{{ slot.display_time }}</span>
      {% if slot.is_booked %}
      <div class="mt-1 inline-flex items-center gap-1 text-xs font-semibold text-sky-800 dark:text-sky-100">
        <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-amber-900 dark:bg-amber-400/30 dark:text-amber-50">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm2 6a1 1 0 112 0v3.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3A1 1 0 016.707 10.293L8 11.586V8z" clip-rule="evenodd" />
          </svg>
          Booked{% if slot.booking_student_name %} by {{ slot.booking_student_name }}{% endif %}
        </span>
      </div>
      {% if slot.booking_message %}
      <div class="mt-1 flex items-start gap-1.5 text-sm text-sky-900/90 dark:text-sky-50">
        <span class="mt-0.5 text-sky-500 dark:text-sky-300">
          {% include "core/icons/chat.html" with class="h-4 w-4" %}
        </span>
        <span>
          <span class="font-semibold text-sky-900 dark:text-sky-100">Student note:</span>
          {{ slot.booking_message }}
        </span>
      </div>
      {% endif %}
      {% endif %}
    </div>

    {# Meeting Type Buttons or Blocked Message #}
    <div class="flex gap-2 flex-1 items-center">
      <template x-if="!isBlocked">
        <div class="flex gap-2 flex-1 items-center">
          <button
            type="button"
            @click="startSetType('online')"
            :disabled="saving"
            :class="{
              'bg-blue-500 text-white border-blue-600 dark:bg-blue-600 dark:border-blue-400': isActive('online'),
              'border-input hover:bg-blue-100 dark:hover:bg-blue-900/40': !isActive('online')
            }"
            class="px-3 py-1.5 text-xs rounded-md border transition-colors disabled:opacity-50 text-slate-900 dark:text-slate-100"
          >
            Online
          </button>

          <button
            type="button"
            @click="startSetType('in_person')"
            :disabled="saving"
            :class="{
              'bg-green-500 text-white border-green-600 dark:bg-green-600 dark:border-green-400': isActive('in_person'),
              'border-input hover:bg-green-100 dark:hover:bg-green-900/40': !isActive('in_person')
            }"
            class="px-3 py-1.5 text-xs rounded-md border transition-colors disabled:opacity-50 text-slate-900 dark:text-slate-100"
          >
            In-person
          </button>

          <button
            type="button"
            @click="startSetType('both')"
            :disabled="saving"
            :class="{
              'bg-purple-500 text-white border-purple-600 dark:bg-purple-600 dark:border-purple-400': isActive('both'),
              'border-input hover:bg-purple-100 dark:hover:bg-purple-900/40': !isActive('both')
            }"
            class="px-3 py-1.5 text-xs rounded-md border transition-colors disabled:opacity-50 text-slate-900 dark:text-slate-100"
          >
            Both
          </button>
        </div>
      </template>

      <template x-if="isBlocked">
        <div class="flex-1 flex items-center gap-2">
          <span class="text-xs text-muted-foreground italic">
            Blocked by meeting above
          </span>
          <span
            x-show="blockingType === 'online'"
            class="px-2 py-1 text-xs rounded-md bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-100 border border-blue-300 dark:border-blue-700"
          >
            Online
          </span>
          <span
            x-show="blockingType === 'in_person'"
            class="px-2 py-1 text-xs rounded-md bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-100 border border-green-300 dark:border-green-700"
          >
            In-person
          </span>
          <span
            x-show="blockingType === 'both'"
            class="px-2 py-1 text-xs rounded-md bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-100 border border-purple-300 dark:border-purple-700"
          >
            Both
          </span>
        </div>
      </template>
    </div>

    <div class="flex flex-col gap-2 flex-1">
      <template x-if="message">
        <div class="w-full px-3 py-2 text-xs rounded-md bg-amber-50 border border-amber-200 text-amber-900 dark:bg-amber-300/20 dark:text-amber-100">
          <span class="font-semibold">Note:</span>
          <span x-text="message"></span>
        </div>
      </template>
      <button
        type="button"
        x-show="selectedType && !isBlocked"
        @click="editMessage()"
        :disabled="saving"
        class="inline-flex w-fit items-center gap-1.5 text-xs font-medium rounded-md border border-input px-2.5 py-1 hover:bg-accent hover:text-accent-foreground transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {% include "core/icons/chat.html" with class="h-3.5 w-3.5" %}
        Add / Edit note
      </button>
    </div>

    <div
      x-show="showNoteModal"
      x-cloak
      x-transition.opacity
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 px-4"
      @keydown.escape.window="cancelModal()"
    >
      <div class="w-full max-w-lg rounded-xl border bg-card text-card-foreground shadow-xl">
        <div class="border-b px-5 py-4">
          <h3 class="text-lg font-semibold">Add a note for this slot</h3>
          <p class="text-sm text-muted-foreground">
            Students will see this note when browsing availability. You can leave it blank if not needed.
          </p>
        </div>
        <div class="px-5 py-4 space-y-3">
          <label class="text-sm font-medium" for="slot-note-{{ forloop.counter }}">Note (optional)</label>
          <textarea
            id="slot-note-{{ forloop.counter }}"
            x-model="tempMessage"
            maxlength="600"
            rows="4"
            class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
            placeholder="Add context for this slot..."
          ></textarea>
          <div class="text-right text-xs text-muted-foreground">
            <span x-text="(tempMessage || '').length"></span>/600
          </div>
        </div>
        <div class="flex items-center justify-end gap-3 border-t px-5 py-4">
          <button
            type="button"
            class="inline-flex items-center justify-center rounded-md border border-input px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground"
            @click="cancelModal()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
            @click="confirmModal()"
            :disabled="saving"
          >
            Save note
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
