{# Time Slots List - Partial for HTMX updates #}
<div class="space-y-2 max-h-[600px] overflow-y-auto" id="time-slots-container">
  {% for slot in time_slots %}
  <div
    x-data="{
      slotTime: '{{ slot.start_time|time:"H:i:s" }}',
      selectedType: {% if slot.is_available %}'{{ slot.meeting_type }}'{% else %}null{% endif %},
      message: '{{ slot.message|escapejs }}',
      isBlocked: {{ slot.is_blocked|yesno:'true,false' }},
      blockingType: {% if slot.blocking_meeting_type %}'{{ slot.blocking_meeting_type }}'{% else %}null{% endif %},
      isBooked: {{ slot.is_booked|yesno:'true,false' }},
      saving: false,

      init() {
        console.log('Alpine component initialized for slot:', this.slotTime, 'selectedType:', this.selectedType, 'isBlocked:', this.isBlocked);
      },

      isActive(type) {
        return this.selectedType === type;
      },

      async selectType(type) {
        console.log('selectType called with type:', type);
        if (this.saving) return;
        this.saving = true;

        const action = this.selectedType === type ? 'delete' : 'set';
        console.log('Action:', action, 'Current selectedType:', this.selectedType);

        const formData = new FormData();
        formData.append('date', '{{ selected_date|date:"Y-m-d" }}');
        formData.append('start_time', this.slotTime);
        formData.append('meeting_type', type);
        formData.append('message', this.message);
        formData.append('action', action);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        {% if is_admin_view and viewing_teacher %}
        formData.append('teacher_id', '{{ viewing_teacher.id }}');
        {% endif %}

        try {
          const response = await fetch('{% url 'availability:save_availability' %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData,
          });

          console.log('Response status:', response.status);
          const data = await response.json();
          console.log('Response data:', data);

          if (data.success) {
            // Get current scroll position of the container
            const container = document.getElementById('time-slots-container');
            const scrollTop = container ? container.scrollTop : 0;

            // Trigger HTMX to reload just the time slots section
            // Use pathname + search to preserve query parameters (e.g., ?teacher_id=2)
            htmx.ajax('GET', window.location.pathname + window.location.search, {
              target: '#time-slots-wrapper',
              swap: 'innerHTML show:none'
            }).then(() => {
              // Restore scroll position after swap
              const newContainer = document.getElementById('time-slots-container');
              if (newContainer) {
                newContainer.scrollTop = scrollTop;
              }
            });
          } else {
            alert('Error: ' + (data.error || 'Failed to save availability'));
            this.saving = false;
          }
        } catch (error) {
          console.error('Fetch error:', error);
          alert('Error: ' + error.message);
          this.saving = false;
        }
      },

      async saveMessage() {
        console.log('saveMessage called');
        if (this.saving || !this.selectedType) return;
        this.saving = true;

        const formData = new FormData();
        formData.append('date', '{{ selected_date|date:"Y-m-d" }}');
        formData.append('start_time', this.slotTime);
        formData.append('meeting_type', this.selectedType);
        formData.append('message', this.message);
        formData.append('action', 'set');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        {% if is_admin_view and viewing_teacher %}
        formData.append('teacher_id', '{{ viewing_teacher.id }}');
        {% endif %}

        try {
          const response = await fetch('{% url 'availability:save_availability' %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData,
          });

          console.log('saveMessage response status:', response.status);
          const data = await response.json();
          console.log('saveMessage response data:', data);

          if (data.success) {
            console.log('Message saved successfully');
            this.saving = false;
          } else {
            alert('Error: ' + (data.error || 'Failed to save message'));
            this.saving = false;
          }
        } catch (error) {
          console.error('saveMessage fetch error:', error);
          alert('Error: ' + error.message);
          this.saving = false;
        }
      }
    }"
    :class="{
      'bg-sky-50 border-sky-200 ring-1 ring-sky-100': isBooked,
      'opacity-60 bg-muted': isBlocked && !isBooked,
      'bg-card hover:bg-accent/50': !isBlocked && !isBooked
    }"
    class="flex items-center gap-3 p-3 rounded-lg border transition-colors"
  >
    {# Time Display #}
    <div class="min-w-[180px]">
      <span class="text-sm font-medium">{{ slot.display_time }}</span>
      {% if slot.is_booked %}
      <div class="mt-1 inline-flex items-center gap-1 text-xs font-semibold text-sky-800 dark:text-sky-200">
        <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-amber-900 dark:bg-amber-300/20 dark:text-amber-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm2 6a1 1 0 112 0v3.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3A1 1 0 016.707 10.293L8 11.586V8z" clip-rule="evenodd" />
          </svg>
          Booked{% if slot.booking_student_name %} by {{ slot.booking_student_name }}{% endif %}
        </span>
      </div>
      {% if slot.booking_message %}
      <div class="mt-1 flex items-start gap-1.5 text-sm text-sky-900/90 dark:text-sky-100">
        <span class="mt-0.5 text-sky-500 dark:text-sky-300">
          {% include "core/icons/chat.html" with class="h-4 w-4" %}
        </span>
        <span>
          <span class="font-semibold text-sky-900 dark:text-sky-100">Student note:</span>
          {{ slot.booking_message }}
        </span>
      </div>
      {% endif %}
      {% endif %}
    </div>

    {# Meeting Type Buttons or Blocked Message #}
    <div class="flex gap-2 flex-1 items-center">
      <template x-if="!isBlocked">
        <div class="flex gap-2 flex-1 items-center">
          <button
            type="button"
            @click="selectType('online')"
            :disabled="saving"
            :class="{
              'bg-blue-500 text-white border-blue-600': isActive('online'),
              'border-input hover:bg-blue-100': !isActive('online')
            }"
            class="px-3 py-1.5 text-xs rounded-md border transition-colors disabled:opacity-50"
          >
            Online
          </button>

          <button
            type="button"
            @click="selectType('in_person')"
            :disabled="saving"
            :class="{
              'bg-green-500 text-white border-green-600': isActive('in_person'),
              'border-input hover:bg-green-100': !isActive('in_person')
            }"
            class="px-3 py-1.5 text-xs rounded-md border transition-colors disabled:opacity-50"
          >
            In-person
          </button>

          <button
            type="button"
            @click="selectType('both')"
            :disabled="saving"
            :class="{
              'bg-purple-500 text-white border-purple-600': isActive('both'),
              'border-input hover:bg-purple-100': !isActive('both')
            }"
            class="px-3 py-1.5 text-xs rounded-md border transition-colors disabled:opacity-50"
          >
            Both
          </button>

          {# Message Input Field #}
          <input
            type="text"
            x-model="message"
            placeholder="Optional note..."
            maxlength="200"
            :disabled="!selectedType || saving"
            @keydown.enter="saveMessage()"
            @blur="saveMessage()"
            class="flex-1 px-3 py-1.5 text-xs rounded-md border border-input bg-background focus:outline-none focus:ring-1 focus:ring-ring disabled:opacity-50 disabled:cursor-not-allowed"
          >
        </div>
      </template>

      <template x-if="isBlocked">
        <div class="flex-1 flex items-center gap-2">
          <span class="text-xs text-muted-foreground italic">
            Blocked by meeting above
          </span>
          <span
            x-show="blockingType === 'online'"
            class="px-2 py-1 text-xs rounded-md bg-blue-100 text-blue-700 border border-blue-300"
          >
            Online
          </span>
          <span
            x-show="blockingType === 'in_person'"
            class="px-2 py-1 text-xs rounded-md bg-green-100 text-green-700 border border-green-300"
          >
            In-person
          </span>
          <span
            x-show="blockingType === 'both'"
            class="px-2 py-1 text-xs rounded-md bg-purple-100 text-purple-700 border border-purple-300"
          >
            Both
          </span>
        </div>
      </template>
    </div>
  </div>
  {% endfor %}
</div>
