{# Time Slots List - Partial for HTMX updates #}
<div class="space-y-2 max-h-[600px] overflow-y-auto" id="time-slots-container">
  {% for slot in time_slots %}
  <div
    x-data="{
      slotTime: '{{ slot.start_time|time:"H:i:s" }}',
      selectedType: {% if slot.is_available %}'{{ slot.meeting_type }}'{% else %}null{% endif %},
      isBlocked: {{ slot.is_blocked|yesno:'true,false' }},
      blockingType: {% if slot.blocking_meeting_type %}'{{ slot.blocking_meeting_type }}'{% else %}null{% endif %},
      saving: false,

      init() {
        console.log('Alpine component initialized for slot:', this.slotTime, 'selectedType:', this.selectedType, 'isBlocked:', this.isBlocked);
      },

      isActive(type) {
        return this.selectedType === type;
      },

      async selectType(type) {
        console.log('selectType called with type:', type);
        if (this.saving) return;
        this.saving = true;

        const action = this.selectedType === type ? 'delete' : 'set';
        console.log('Action:', action, 'Current selectedType:', this.selectedType);

        const formData = new FormData();
        formData.append('date', '{{ selected_date|date:"Y-m-d" }}');
        formData.append('start_time', this.slotTime);
        formData.append('meeting_type', type);
        formData.append('action', action);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
          const response = await fetch('{% url 'availability:save_availability' %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData,
          });

          console.log('Response status:', response.status);
          const data = await response.json();
          console.log('Response data:', data);

          if (data.success) {
            // Get current scroll position of the container
            const container = document.getElementById('time-slots-container');
            const scrollTop = container ? container.scrollTop : 0;

            // Trigger HTMX to reload just the time slots section
            htmx.ajax('GET', window.location.pathname, {
              target: '#time-slots-wrapper',
              swap: 'innerHTML show:none'
            }).then(() => {
              // Restore scroll position after swap
              const newContainer = document.getElementById('time-slots-container');
              if (newContainer) {
                newContainer.scrollTop = scrollTop;
              }
            });
          } else {
            alert('Error: ' + (data.error || 'Failed to save availability'));
            this.saving = false;
          }
        } catch (error) {
          console.error('Fetch error:', error);
          alert('Error: ' + error.message);
          this.saving = false;
        }
      }
    }"
    :class="{
      'opacity-60 bg-muted': isBlocked,
      'bg-card hover:bg-accent/50': !isBlocked
    }"
    class="flex items-center gap-3 p-3 rounded-lg border transition-colors"
  >
    {# Time Display #}
    <div class="min-w-[180px]">
      <span class="text-sm font-medium">{{ slot.display_time }}</span>
    </div>

    {# Meeting Type Buttons or Blocked Message #}
    <div class="flex gap-2 flex-1 items-center">
      <template x-if="!isBlocked">
        <div class="flex gap-2 flex-1">
          <button
            type="button"
            @click="selectType('online')"
            :disabled="saving"
            :class="{
              'bg-blue-500 text-white border-blue-600': isActive('online'),
              'border-input hover:bg-blue-100': !isActive('online')
            }"
            class="px-3 py-1.5 text-xs rounded-md border transition-colors disabled:opacity-50"
          >
            Online
          </button>

          <button
            type="button"
            @click="selectType('in_person')"
            :disabled="saving"
            :class="{
              'bg-green-500 text-white border-green-600': isActive('in_person'),
              'border-input hover:bg-green-100': !isActive('in_person')
            }"
            class="px-3 py-1.5 text-xs rounded-md border transition-colors disabled:opacity-50"
          >
            In-person
          </button>

          <button
            type="button"
            @click="selectType('both')"
            :disabled="saving"
            :class="{
              'bg-purple-500 text-white border-purple-600': isActive('both'),
              'border-input hover:bg-purple-100': !isActive('both')
            }"
            class="px-3 py-1.5 text-xs rounded-md border transition-colors disabled:opacity-50"
          >
            Both
          </button>
        </div>
      </template>

      <template x-if="isBlocked">
        <div class="flex-1 flex items-center gap-2">
          <span class="text-xs text-muted-foreground italic">
            Blocked by meeting above
          </span>
          <span
            x-show="blockingType === 'online'"
            class="px-2 py-1 text-xs rounded-md bg-blue-100 text-blue-700 border border-blue-300"
          >
            Online
          </span>
          <span
            x-show="blockingType === 'in_person'"
            class="px-2 py-1 text-xs rounded-md bg-green-100 text-green-700 border border-green-300"
          >
            In-person
          </span>
          <span
            x-show="blockingType === 'both'"
            class="px-2 py-1 text-xs rounded-md bg-purple-100 text-purple-700 border border-purple-300"
          >
            Both
          </span>
        </div>
      </template>
    </div>
  </div>
  {% endfor %}
</div>
